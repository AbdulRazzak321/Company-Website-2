<!DOCTYPE html>
<html lang="en">
<!--

  Want to apply for a developer job? Follow this path: http://challenge.futurice.com/

-->

<!-- Mirrored from futurice.com/blog/id-like-to-have-some-lcd-on-my-pi by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 14 Apr 2016 08:26:58 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head prefix="og: http://ogp.me/ns#">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <!--[if lt IE 9]><script src="//static.flockler.com/assets/html5shiv/html5shiv-3.7.2-411c036062e933ea2996a9e81d0a1a10.js" type="text/javascript"></script><![endif]-->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0"/>
  <link rel="alternate" type="application/rss+xml" title="Futurice Blog" href="rss">

  <title>I&#x27;d like to have some LCD on my Pi — Futurice</title>
  <link rel="icon" type="image/png" href="../../static.flockler.com/assets/futurice/images/favicon-73ef94531581d9f27e41233515c60919.png">
  <!--[if IE]>
    <link rel="shortcut icon" href="//static.flockler.com/assets/futurice/images/favicon-3225e8217799f7ff156f47c394d9eb67.ico"/>
  <![endif]-->

  
  <meta property="og:title" content="I&#x27;d like to have some LCD on my Pi — Futurice">
  <meta property="og:description" name="description" content="A story of how I got my cheap 3.5&quot; LCD touch screen ordered from Hong Kong to work with my Raspberry Pi computer.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="id-like-to-have-some-lcd-on-my-pi.html">
  <meta property="og:image" content="../../flockler.com/thumbs/1992/photo-25-3-2015-23-53-48_s1200x630_q80_noupscale.jpg">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">


  <script src="../../use.typekit.net/yvs3xkq.js"></script>
  <script>try{Typekit.load();}catch(e){}</script>

  <link href="../../static.flockler.com/assets/futurice/stylesheets/application-c89517cc680dd524a0b43dc0e8f7f8ce.css" media="screen" rel="stylesheet" type="text/css" />

</head>
<body class="view--articles view--articles-show is-article-view is-blog-post-view" itemscope itemtype="http://schema.org/WebPage">
  <!-- Google Tag Manager -->
<noscript><iframe src="http://www.googletagmanager.com/ns.html?id=GTM-M2CWVJ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'../../www.googletagmanager.com/gtm5445.html?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-M2CWVJ');</script>
<!-- End Google Tag Manager -->

<div style="display:none">
  <!-- Google Code for Remarketing Tag -->
  <script type="text/javascript">
  /* <![CDATA[ */
    var google_conversion_id = 997302464;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
  /* ]]> */
  </script>
  <script type="text/javascript" src="../../www.googleadservices.com/pagead/f.txt"></script>
  <noscript><div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="http://googleads.g.doubleclick.net/pagead/viewthroughconversion/997302464/?value=0&amp;guid=ON&amp;script=0"/></div></noscript>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15911025-14', 'auto', {'name': 'flocklerInternal'});
  ga('flocklerInternal.html', 'forceSSL', true);
  ga('flocklerInternal.send', 'pageview');
</script>


  <nav class="nav" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
  <div class="nav__padding">
    <a href="../index.html" class="nav__logo-link">
      <img alt="Futurice" class="nav__logo" onerror="this.onerror=null;this.src='../assets/futurice/images/futurice-logo--green.png';" src="http://static.flockler.com/assets/futurice/images/futurice-logo--green.svg" />
</a>    <div class="nav-collapse">
      <ul class="nav__items">
        <li class="nav__item">
          <a href="../work.html">Work</a>
        </li>
        <li class="nav__item">
          <a href="../services.html">Services</a>
        </li>
        <li class="nav__item">
          <a href="../culture.html">Culture</a>
        </li>
        <li class="nav__item">
          <a href="../careers.html">Careers</a>
        </li>
        <li class="nav__item">
          <a href="../events.html">Events</a>
        </li>
        <li class="nav__item">
          <a href="../people.html">People</a>
        </li>
        <li class="nav__item">
          <a href="../blog.html">Blog</a>
        </li>
        <li class="nav__item">
          <a href="../contact.html">Contact</a>
        </li>
        <li class="nav__item nav__item--search">
          <a href="../search.html"><i class="icon-search"></i><span>Search</span></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <header class="header" role="banner" itemscope itemtype="http://schema.org/WPHeader">
  <div class="header__container">
    <img alt="Bg-1" onerror="this.onerror=null;this.src='../assets/futurice/images/backgrounds/bg-1.png';" src="http://static.flockler.com/assets/futurice/images/backgrounds/bg-1.svg" />

  </div>
</header>

  <main class="main" role="main" itemscope itemprop="mainContentOfPage" itemtype="http://schema.org/WebPage">
    
  <div class="article-wrapper">
  <article class="article" itemscope itemprop="blogPost" itemtype="http://schema.org/BlogPosting">
    <header class="article__header">
      <div class="article__header__meta">
        <time class="article__header__meta__published-at" itemprop="datePublished" datetime="2015-03-26T20:23:21Z">
          March 26, 2015
        </time>
          <span class="article__header__meta__category" itemprop="articleSection">
            Software development
          </span>
      </div>

      <h1 class="article__header__title" itemprop="headline">
        I&#x27;d like to have some LCD on my Pi
      </h1>

      <div class="article__header__meta">
          <div class="article__header__meta__item article__header__author" itemprop="author" itemscope itemptype="http://schema.org/Person">
              <span class="article__header__author-link" rel="author">
                <div class="article__header__meta__item__body">
                  <span class="article__header__author-name" itemprop="name">Juho Vähä-Herttua</span>
                  <span class="article__header__author-title" itemprop="jobTitle">Senior Software Engineer</span>
                </div>
              </span>
          </div>

          <div class="article__header__tags">
            <span class="article__header__tags-label">Topics</span>
            <div class="article__header__meta__item__body article__header__tags__body">
                <a href="../search757b.html?q=Raspberry%20Pi" class="article__header__tag-link">
                  <span class="article__header__tag-name">Raspberry Pi</span></a>, 
                <a href="../searchd236.html?q=LCD" class="article__header__tag-link">
                  <span class="article__header__tag-name">LCD</span></a>, 
                <a href="../search744a.html?q=Linux" class="article__header__tag-link">
                  <span class="article__header__tag-name">Linux</span></a>, 
                <a href="../search9f93.html?q=Raspbian" class="article__header__tag-link">
                  <span class="article__header__tag-name">Raspbian</span></a>, 
                <a href="../searcheed0.html?q=fbtft" class="article__header__tag-link">
                  <span class="article__header__tag-name">fbtft</span></a>
            </div>
          </div>
      </div>
    </header>
    <div class="article__body" itemprop="articleBody">
      <h3 class="article__heading--h3">Update 2015-04-22:</h3>

<p>The latest kernel does not use the <em>ads7846_device</em> module any more but uses <em>device tree</em> configuration instead. The instructions are now updated accordingly, thank you to Lauri Anttila for reporting this.</p>

<h2 class="article__heading--h2">Backstory</h2>

<p>One evening I was browsing around ebay.com and came across these pretty cheap less than $30 (including postage) LCD touch screens for Raspberry Pi. I happen to have one Raspberry Pi B+ lying around that didn't work that well in its original intention, but I have had some plans to repurpose it as a controlling device for solar panel charging and electricity in our summer house. A small touch screen would fit that purpose quite nicely, so let's order one of these and try it out first.</p>

<h2 class="article__heading--h2">TL;DR</h2>

<p>I got it working as the main screen in both portrait and landscape mode, the configuration I use for landscape is as follows:</p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">Update firmware with:
sudo REPO_URI=https://github.com/notro/rpi-firmware rpi-update

Enable SPI in raspi-config.

/etc/modules:
flexfb nobacklight regwidth=16 init=-1,0xb0,0x0,-1,0x11,-2,250,-1,0x3A,0x55,-1,0xC2,0x44,-1,0xC5,0x00,0x00,0x00,0x00,-1,0xE0,0x0F,0x1F,0x1C,0x0C,0x0F,0x08,0x48,0x98,0x37,0x0A,0x13,0x04,0x11,0x0D,0x00,-1,0xE1,0x0F,0x32,0x2E,0x0B,0x0D,0x05,0x47,0x75,0x37,0x06,0x10,0x03,0x24,0x20,0x00,-1,0xE2,0x0F,0x32,0x2E,0x0B,0x0D,0x05,0x47,0x75,0x37,0x06,0x10,0x03,0x24,0x20,0x00,-1,0x36,0x28,-1,0x11,-1,0x29,-3 width=480 height=320
fbtft_device name=flexfb speed=16000000 gpios=reset:25,dc:24

/boot/cmdline.txt:
add: fbcon=map:1 fbcon=font:ProFont6x11

/usr/share/X11/xorg.conf.d/99-fbturbo.conf:
change fb0 to fb1

/boot/config.txt
add line: dtoverlay=ads7846,speed=500000,penirq=17,swapxy=1

/usr/share/X11/xorg.conf.d/99-calibration.conf:
Section "InputClass"
        Identifier      "calibration"
        MatchProduct    "ADS7846 Touchscreen"
        Option  "Calibration"   "3900 240 240 3900"
EndSection</code></pre>

<h2 class="article__heading--h2">Assembly Line</h2>

<p><span>The package arrived from Hong Kong and it contained an LCD module, some pieces of plastic, heatsinks and a DVD with no instruction manual whatsoever. </span></p>

<figure contenteditable="false" data-flockler="image-add"><img alt="This is what I got in the box...​" src="../../flockler.com/thumbs/1992/photo-25-3-2015-21-51-23--x2regkinjm_s830x0_q80_noupscale.jpg">
<figcaption><span class="image-caption-title" contenteditable="false">This is what I got in the box...​</span></figcaption>
</figure>

<p><span>Well, you get what you pay for and with this price it seems reasonable, so let's just get assembling. After several attempts I finally got the thing into a respectable state, which actually looks pretty nice!</span></p>

<figure contenteditable="false" data-flockler="image-add"><img alt="...and this is how it looks like after completing the puzzle.​" src="../../flockler.com/thumbs/1992/photo-25-3-2015-21-54-06--70evyp0dic_s830x0_q80_noupscale.jpg">
<figcaption><span class="image-caption-title" contenteditable="false">...and this is how it looks like after completing the puzzle.​</span></figcaption>
</figure>

<p>At this point I'm all excited to get this running, right? So I go to the <a href="http://www.raspberrypi.org/downloads/">official download site</a>, download the latest Raspbian image (which is quite widely supported) and copy it to my SD card. After getting the keyboard, network, HDMI and power wires connected, the device boots very nicely and greets us with the usual Raspbian configuration screen.</p>

<figure contenteditable="false" data-flockler="image-add"><img alt="First boot of the system with two screens.​" src="../../flockler.com/thumbs/1992/photo-25-3-2015-22-01-43_s830x0_q80_noupscale.jpg">
<figcaption><span class="image-caption-title" contenteditable="false">First boot of the system with two screens.​</span></figcaption>
</figure>

<p>I do the usual routine of expanding disk size, changing password, setting locale and keyboard map, but at the same time I feel a bit nervous, because my fancy new screen stays all white...</p>

<h2 class="article__heading--h2">Using LCD Responsibly</h2>

<p class="article__paragraph"><span>Now that we have everything set up but the screen doesn't show anything, more problems come up. When I try to fit the small DVD that came with the device to my Macbook Pro DVD drive, it just doesn't fit there (or rather fits too deep), so I have no drivers or instructions. We would be totally screwed at this point..if we didn't have the Internet!</span></p>

<p>Searching around and looking at the devices shows that the LCD I got:</p>

<ol>
	<li>is called <a href="http://www.wvshare.com/product/3.5inch-RPi-LCD-A.htm">Waveshare Spotpear 3.5" RPi LCD (A)</a>
</li>
	<li>can be run by the <a href="https://github.com/notro/fbtft">fbtft</a> driver by this awesome fellow called Noralf Trønnes</li>
	<li><span>is not officially supported yet, but with <a href="https://github.com/notro/fbtft/wiki/flexfb">flexfb</a> one can tweak parameters manually</span></li>
</ol>

<p class="article__paragraph"><span><span>​Further investigation tells us more both bad news and good news. Bad news is that the <em>fbtft </em>driver is not included in the kernel of our Raspbian distro yet, but good news is that the helpful author has binary images made for Raspberry Pi users at </span></span><a href="https://github.com/notro/rpi-firmware">https://github.com/notro/rpi-firmware </a>and it is just a single command to update. So let's start with that.</p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">pi@raspberrypi ~ $ sudo REPO_URI=https://github.com/notro/rpi-firmware rpi-update
pi@raspberrypi ~ $ sudo reboot</code></pre>

<figure contenteditable="false" data-flockler="image-add"><img alt="Raspberry Pi firmware being upgraded to include the fbtft drivers​​" src="../../flockler.com/thumbs/1992/photo-25-3-2015-22-24-05_s830x0_q80_noupscale.jpg">
<figcaption><span class="image-caption-title" contenteditable="false">Raspberry Pi firmware being upgraded to include the fbtft drivers​​</span></figcaption>
</figure>

<p class="article__paragraph"><span>Now we should have all the drivers we need, so let's look at <a href="https://github.com/notro/fbtft/issues/215">a GitHub issue</a></span><span> we found discussing this exact same device, looks like someone else has a better DVD drive and has already posted logs from the official drivers, which is almost all we need to get the LCD running.</span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">fbtft_request_gpios: 'reset' =GPIO025
fbtft_request_gpios: 'dc' =GPIO024
flexfb_verify_gpios_dc()
fbtft_init_display()
fbtft_reset()
init: write(0xB0) 0x00
init: write(0x11)
init: mdelay(250)
init: write(0x3A) 0x55
init: write(0xC2) 0x44
init: write(0xC5) 0x00 0x00 0x00 0x00
init: write(0xE0) 0x0F 0x1F 0x1C 0x0C 0x0F 0x08 0x48 0x98 0x37 0x0A 0x13 0x04 0x11 0x0D 0x00
init: write(0xE1) 0x0F 0X32 0x2E 0x0B 0x0D 0x05 0x47 0x75 0x37 0x06 0x10 0x03 0x24 0x20 0x00
init: write(0xE2) 0x0F 0X32 0x2E 0x0B 0x0D 0x05 0x47 0x75 0x37 0x06 0x10 0x03 0x24 0x20 0x00
init: write(0x36) 0x28
init: write(0x11)
init: write(0x29)
Display update: 1691kB/s (177.354ms),fps=0 (0.000 ms) 
fbtft_register_backlight()
fbtft_register_backlight(): led pin not set, exiting
graphics fb1: flexb frame buffer, 480x320, 300kiB video memory, 4 kiB DMA buffer memory, fps=20, spi0.0 at 16MHz
fbtft_device: spidev spi0.1 500kHZ 8 bits mode=0x00
fbtft_device: flexfb spi0.0 16000kHZ 8 bits mode=0x00
ads7846_device: Deleting spi0.1
ads7846 spi0.1: touchscreen, irq 187
input ADS7846 Touchscreen as /devices/platform/bcm2708_spi.0/spi_master/spi0/spi0.1/input/input1</code></pre>

<p class="article__paragraph">This may seem cryptic, but when you look at it for a while it it's telling you quite many things. First, the GPIO pins for reset and dc (data command) are detected to be 25 and 24 respectively. Second, initializing the screen requires 11 writes with one 250ms delay in the middle. Third, the screen has resolution of 480x320 with 20fps frame rate and 16000kHz data transfer rate, no programmable backlight and it is located on SPI bus 0 chip 0. Fourth, we have a touchscreen on SPI bus 0 chip 1 with transfer rate of 500kHz.</p>

<p class="article__paragraph">One information missing from that log is the regwidth, which some of our friends on GitHub have already found out to be 16 bits. The flexfb driver supports giving custom init sequences as an array by using -1 for write command, -2 for delay and -3 for end of init sequence. Therefore on the console we can try the following:</p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">pi@raspberrypi ~ $ sudo modprobe flexfb nobacklight regwidth=16 init=-1,0xb0,0x0,-1,0x11,-2,250,-1,0x3A,0x55,-1,0xC2,0x44,-1,0xC5,0x00,0x00,0x00,0x00,-1,0xE0,0x0F,0x1F,0x1C,0x0C,0x0F,0x08,0x48,0x98,0x37,0x0A,0x13,0x04,0x11,0x0D,0x00,-1,0xE1,0x0F,0x32,0x2E,0x0B,0x0D,0x05,0x47,0x75,0x37,0x06,0x10,0x03,0x24,0x20,0x00,-1,0xE2,0x0F,0x32,0x2E,0x0B,0x0D,0x05,0x47,0x75,0x37,0x06,0x10,0x03,0x24,0x20,0x00,-1,0x36,0x28,-1,0x11,-1,0x29,-3 width=480 height=320
pi@raspberrypi ~ $ sudo modprobe fbtft_device name=flexfb speed=16000000 gpios=reset:25,dc:24
ERROR: could not insert 'fbtft_device': Invalid argument</code></pre>

<p class="p1"><span>Ok, that didn't work quite as expected, our arguments should all be valid so where is this invalid argument coming from? Easiest is to check from dmesg which prints the kernel log:</span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">pi@raspberrypi ~ $ dmesg | tail
[   10.945412] EXT4-fs (mmcblk0p2): re-mounted. Opts: (null)
[   11.483292] EXT4-fs (mmcblk0p2): re-mounted. Opts: (null)
[   22.020254] smsc95xx 1-1.1:1.0 eth0: hardware isn't capable of remote wakeup
[   23.609241] smsc95xx 1-1.1:1.0 eth0: link up, 100Mbps, full-duplex, lpa 0xCDE1
[   29.310875] Adding 102396k swap on /var/swap.  Priority:-1 extents:2 across:2134012k SSFS
[  216.893064] fbtft_device:  SPI devices registered:
[  216.893106] fbtft_device:  'fb' Platform devices registered:
[  216.893152] fbtft_device:      bcm2708_fb id=-1 pdata? no
[  216.893214] fbtft_device:  spi_busnum_to_master(0) returned NULL
[  216.893226] fbtft_device: failed to register SPI device
</code></pre>

<p class="p1">As we already have found out, our device uses <a href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface_Bus">SPI</a>, which is a standard for communicating with peripherals quite common in embedded systems, for communication between the main system and the LCD. There is a kernel module for SPI, but it is not enabled by default, so we have to go back to raspi-config and enable it.</p>

<figure contenteditable="false" data-flockler="image-add"><img alt="Enabling SPI driver in the raspi-config settings​" src="../../flockler.com/thumbs/1992/enable_spi_s830x0_q80_noupscale.jpg">
<figcaption><span class="image-caption-title" contenteditable="false">Enabling SPI driver in the raspi-config settings​</span></figcaption>
</figure>

<p class="p1">The raspi-config suggests that we reboot now and we can do that. After reboot if we run the two modprobes again, something magical happens! The screen turns from white to black. It is possible that the screen is already working, but we need some way to prove it. Luckily there is this great command called <strong><em>con2fbmap</em></strong>, which can be used to map our console to another framebuffer. So if we simply try out <strong><em>con2fbmap 1 1</em></strong> it should map our main console to the first framebuffer, and it does! We can change back to HDMI output by simply writing <strong><em>con2fbmap 1 0</em></strong>, and the console moves back there magically.</p>

<p class="p1">Being quite confident that everything is now in order, we have to make these changes persistent over reboots. To do that we will add the following two lines to the system configuration by using <strong><em>sudo nano /etc/modules</em></strong>:</p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">flexfb regwidth=16 nobacklight init=-1,0xb0,0x0,-1,0x11,-2,250,-1,0x3A,0x55,-1,0xC2,0x44,-1,0xC5,0x00,0x00,0x00,0x00,-1,0xE0,0x0F,0x1F,0x1C,0x0C,0x0F,0x08,0x48,0x98,0x37,0x0A,0x13,0x04,0x11,0x0D,0x00,-1,0xE1,0x0F,0x32,0x2E,0x0B,0x0D,0x05,0x47,0x75,0x37,0x06,0x10,0x03,0x24,0x20,0x00,-1,0xE2,0x0F,0x32,0x2E,0x0B,0x0D,0x05,0x47,0x75,0x37,0x06,0x10,0x03,0x24,0x20,0x00,-1,0x36,0x28,-1,0x11,-1,0x29,-3 width=480 height=320
fbtft_device name=flexfb speed=16000000 gpios=reset:25,dc:24</code></pre>

<p class="p1">Now it should be ok to reboot and make sure that the screen still turns black on boot. In our case we also want to get rid of the huge TV set, so we want to make the LCD screen the default screen for the system. On Linux the console and graphical environment work a bit differently. Our old screen is in <em>fb0</em> and our new screen is in <em>fb1</em>, so to move the system console to our new screen we write <strong><em>sudo nano /boot/cmdline.txt</em></strong> and to the end of the line add the arguments <em><strong>fbcon=map:1 fbcon=font:ProFont6x11</strong></em>. The first argument maps the console to fb1 and the second argument changes the font to a smaller one (6x11 pixels).</p>

<p class="p1">It is possible to move the graphical environment to <em>fb1</em> as well by <strong><em>sudo nano /usr/share/X11/xorg.conf.d/99-fbturbo.conf</em></strong> and simply changing the fb0 entry to fb1. For the changes to take effect we need to restart the graphical environment. Since we have made quite many changes, it's easier to just reboot the whole device and see everything moved to the LCD screen instead of the HDMI output.</p>

<figure contenteditable="false" data-flockler="image-add"><img alt="After the boot, after successful modprobe, after con2fbmap, and finally after the reboot​" src="../../flockler.com/thumbs/1992/all_screens_s830x0_q80_noupscale.jpg">
<figcaption><span class="image-caption-title" contenteditable="false">After the boot, after successful modprobe, after con2fbmap, and finally after the reboot​</span></figcaption>
</figure>

<h2 class="article__heading--h2">Touch Me Like You Do</h2>

<p>Now the screen is in perfect order, but as we still remember it also has touch capabilities. There is a ads7846 module in the system, but we need to give it the correct parameters and load it. This can be done with the <a href="https://github.com/raspberrypi/firmware/blob/master/boot/overlays/README">device tree overlay</a> functionality of the firmware.</p>

<p>Our friends on GitHub again already found out that the penirq interrupt value should be 17, so we need to give some parameters to the kernel by using <em><strong>sudo nano /boot/config.txt</strong></em> and adding line:</p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">dtoverlay=ads7846,speed=500000,penirq=17</code></pre>

<p>After reboot we do get the touch screen working ok, but things don't seem quite right. If we move it horizontally it actually moves vertically and vice versa. And it looks like the locations are not quite correct either. Actually for touch input we need to be able to calibrate three things correctly:</p>

<ol>
	<li>X and Y axis need to be correct for the screen orientation</li>
	<li>Both X and Y axis need to have minimum and maximum range defined</li>
	<li>Both X and Y axis need to work to the correct direction</li>
</ol>

<p>Because horizontal movement moves the mouse vertically and vice versa, we clearly have problems with step 1. This means that even though our screen is in landscape mode, the touch screen is actually in portrait mode and has the x and y axis swapped. So we should modify the <em>config.txt</em> parameters as follows:</p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">dtoverlay=ads7846,speed=500000,penirq=17,swapxy=1</code></pre>

<p class="p1">After rebooting again this helps a bit and the y coordinate is about right but a bit in the wrong location, and the x coordinate moves left when we try to move right and vice versa, these are the problems 2 and 3 above. To make things easier we skip a few steps (more about that in the end of this post) and simply use <strong><em><span>sudo nano /usr/share/X11/xorg.conf.d/99-calibration.conf</span></em></strong><span> to copypaste the following to the new file:</span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">Section "InputClass"
    Identifier    "calibration"
    MatchProduct    "ADS7846 Touchscreen"
    Option    "Calibration"    "3900 240 240 3900"
EndSection</code></pre>

<p class="p1">Now you may ask, what are these magic numbers in calibration and what do they do? Well, the numbers are simply values <em>"min_x max_x min_y max_y"</em> in that order. They are device specific values that define the minimum and maximum values coming from the touch screen. You might remember that our x coordinates were wrong, but since here max_x is larger than min_x the system uses that information to automatically invert the x coordinates and that's why everything works.</p>

<p class="p1"><span>After reboot we try to use the stylus to open a browser and keyboard to navigate to some website. Finally our touch screen works perfectly and the touch events go to the right spot!</span></p>

<figure contenteditable="false" data-flockler="image-add"><img alt="Reading our favourite newspaper with the touch screen​" src="../../flockler.com/thumbs/1992/photo-25-3-2015-23-53-48_s830x0_q80_noupscale.jpg">
<figcaption><span class="image-caption-title" contenteditable="false">Reading our favourite newspaper with the touch screen​</span></figcaption>
</figure>

<h2 class="article__heading--h2"><span>Turn Around, Bright Eyes</span></h2>

<p class="p1">Our screen is now always in landscape mode, we might want to turn it around to portrait mode. And once again our friends on GitHub already realized that by modifying the <em>-1,0x36,0x28</em> sequence in init we can turn the screen around, more specifically we need to edit the <em>0x28</em> byte. Problem with editing this is that it will also change the screen resolution and the touch screen x and y axes configuration. Through several experiments I have collected the correct parameter combinations below:</p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">  init  width  height  swapxy  calibration
  0x28    480     320       1  "3900 240 240 3900"
  0x48    320     480       0  "3900 240 3900 240"
  0x88    320     480       0  "240 3900 240 3900"
  0xE8    480     320       1  "240 3900 3900 240"
</code></pre>

<p class="p1">To use them you need to modify the byte in <em>init</em>, change <em>width</em> and <em>height</em> arguments accordingly, change <em>swap_xy</em> argument for the touch screen, and finally edit touch screen calibration in <em>/usr/share/X11/xorg.conf.d/99-calibration.conf</em>. We decide to try the second to last line, which is in fact the native mode of our touch screen input, since its calibration has no x or y axis swapped. Discussions on GitHub suggest that some other people with the same device have small variations in the touch screen calibration. After reboot our device screen has turned 90 degrees and still looks nice.</p>

<figure contenteditable="false" data-flockler="image-add"><img alt="Portrait mode in action, a bit too narrow for the status bar.​​" src="../../flockler.com/thumbs/1992/fullsizerender--36ydzl2fmu_s830x0_q80_noupscale.jpg">
<figcaption><span class="image-caption-title" contenteditable="false">Portrait mode in action, a bit too narrow for the status bar.​​</span></figcaption>
</figure>

<h2 class="article__heading--h2">Show Me Your Magic</h2>

<p class="p1">We have talked about the calibration of the touch screen a lot and have used some numbers, but you might want to know where those numbers are coming from. The answer is quite simple, there's a very useful tool called <a href="https://github.com/tias/xinput_calibrator">xinput_calibrator</a> that can do the calibration for us. <span>These instructions assume we have the graphical environment running and are commanding the system either through SSH connection or in a console window.</span></p>

<p class="p1"><span>The problem with xinput_calibrator is that it's only available in Debian testing (jessie) and our Raspbian distro is based on older Debian stable (wheezy). There are some binaries lying around, but personally I don't like to trust random binaries, so I simply compiled the <em>xinput_calibrator</em> myself:</span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">sudo apt-get install libx11-dev libxext-dev libxi-dev x11proto-input-dev
wget http://github.com/downloads/tias/xinput_calibrator/xinput_calibrator-0.7.5.tar.gz
tar xzvf xinput_calibrator-0.7.5.tar.gz
cd xinput_calibrator-0.7.5/
./configure
make
sudo make install
</code></pre>

<p class="p1">We now have a <em>xinput_calibrator </em>installed under our <em>/usr/local/</em> directory. Then we can simply run it and see what happens, first here is an example console output:</p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">pi@raspberrypi ~ $ DISPLAY=":0.0" /usr/local/bin/xinput_calibrator 
Calibrating EVDEV driver for "ADS7846 Touchscreen" id=8
    current calibration values (from XInput): min_x=0, max_x=4095 and min_y=0, max_y=4095

Doing dynamic recalibration:
    Setting new calibration data: 3900, 240, 240, 3900


--&gt; Making the calibration permanent &lt;--
  copy the snippet below into '/etc/X11/xorg.conf.d/99-calibration.conf'
Section "InputClass"
    Identifier    "calibration"
    MatchProduct    "ADS7846 Touchscreen"
    Option    "Calibration"    "3900 240 240 3900"
EndSection</code></pre>

<p class="p1">And below is what it looks like on the screen.</p>

<figure contenteditable="false" data-flockler="image-add"><img alt="Calibration of the touch screen with stylus​" src="../../flockler.com/thumbs/1992/photo-25-3-2015-23-44-08_s830x0_q80_noupscale.jpg">
<figcaption><span class="image-caption-title" contenteditable="false">Calibration of the touch screen with stylus​</span></figcaption>
</figure>

<p class="p1">So one simply has to click on the crosshairs on the screen and the application will print a correct configuration to the console. One important thing to notice is that the given path <em>/etc/X11/xorg.conf.d/99-calibration.conf</em> is not correct on Raspbian and the earlier mentioned <em>/usr/share/X11/xorg.conf.d/99-calibration.conf</em> should be used instead.</p>

<h3 class="article__heading--h3">That's all Folks!</h3>

<p><em>All text and images in this post are licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> license, feel free to distribute.</em></p>

    </div>

    <footer class="article__footer">
      <span class="article__footer__item article__author" itemprop="author" itemscope itemptype="http://schema.org/Person">
        <span class="article__footer__item__label">Written by</span>
        <div class="article__footer__item__body">
            <span class="article__author-link" rel="author">
              <span class="article__author-name" itemprop="name">Juho Vähä-Herttua</span>
            </span>
        </div>
      </span>
        <span class="article__footer__item article__tags">
          <meta itemprop="keywords" content="#&lt;Tag:0x007f6f6038c648&gt;, #&lt;Tag:0x007f6f6038c198&gt;, #&lt;Tag:0x007f6f617c3da0&gt;, #&lt;Tag:0x007f6f617c3490&gt;, #&lt;Tag:0x007f6f617c2ab8&gt;">
          <span class="article__footer__item__label">Topics</span>
          <div class="article__footer__item__body">
              <a href="../search757b.html?q=Raspberry%20Pi" class="article__tag-link">
                <span class="article__tag-name">Raspberry Pi</span></a>, 
              <a href="../searchd236.html?q=LCD" class="article__tag-link">
                <span class="article__tag-name">LCD</span></a>, 
              <a href="../search744a.html?q=Linux" class="article__tag-link">
                <span class="article__tag-name">Linux</span></a>, 
              <a href="../search9f93.html?q=Raspbian" class="article__tag-link">
                <span class="article__tag-name">Raspbian</span></a>, 
              <a href="../searcheed0.html?q=fbtft" class="article__tag-link">
                <span class="article__tag-name">fbtft</span></a>
          </div>
        </span>

      <span class="article__footer__item article__footer__item--share">
  <span class="article__footer__item__label">Share</span>
  <div class="article__footer__item__body">

    <a onClick="event.preventDefault(); window.open('http://www.facebook.com/sharer.php?u=http%3A%2F%2Ffuturice.com%2Fblog%2Fid-like-to-have-some-lcd-on-my-pi', 'sharer', 'toolbar=0,status=0,width=548,height=325');" target="_blank"  class="article__footer__item__share-link" href="http://www.facebook.com/sharer.php?u=http%3A%2F%2Ffuturice.com%2Fblog%2Fid-like-to-have-some-lcd-on-my-pi">
      <i class="icon-facebook"></i>
    </a>

    <a onClick="event.preventDefault(); window.open('https://twitter.com/intent/tweet?text=I%27d%20like%20to%20have%20some%20LCD%20on%20my%20Pi&amp;url=http%3A%2F%2Ffuturice.com%2Fblog%2Fid-like-to-have-some-lcd-on-my-pi', 'sharer', 'toolbar=0,status=0,width=548,height=525');" target="_blank" class="article__footer__item__share-link"
    href="https://twitter.com/intent/tweet?text=I%27d%20like%20to%20have%20some%20LCD%20on%20my%20Pi&amp;url=http%3A%2F%2Ffuturice.com%2Fblog%2Fid-like-to-have-some-lcd-on-my-pi">
      <i class="icon-twitter"></i>
    </a>

    <a onClick="event.preventDefault(); window.open('https://plus.google.com/share?url=http%3A%2F%2Ffuturice.com%2Fblog%2Fid-like-to-have-some-lcd-on-my-pi', 'sharer', 'toolbar=0,status=0,width=548,height=525');" target="_blank" class="article__footer__item__share-link"
    href="https://plus.google.com/share?url=http%3A%2F%2Ffuturice.com%2Fblog%2Fid-like-to-have-some-lcd-on-my-pi">
      <i class="icon-google-plus"></i>
    </a>

    <a onClick="event.preventDefault(); window.open('https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Ffuturice.com%2Fblog%2Fid-like-to-have-some-lcd-on-my-pi&amp;title=I%27d%20like%20to%20have%20some%20LCD%20on%20my%20Pi', 'sharer', 'toolbar=0,status=0,width=548,height=525');" target="_blank" class="article__footer__item__share-link"
    href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Ffuturice.com%2Fblog%2Fid-like-to-have-some-lcd-on-my-pi&amp;title=I%27d%20like%20to%20have%20some%20LCD%20on%20my%20Pi">
      <i class="icon-linkedin"></i>
    </a>
  </div>
</span>

    </footer>
  </article>

    <aside class="related-articles related-articles--tag" role="complementary" itemscope itemtype="http://schema.org/WPSideBar">
      <h2 class="related-articles__heading">More to read</h2>
        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="some-things-never-change.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">Some things never change</h1>
</a></article>

        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="value-creation-from-digital-analytics.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">Value creation from Digital analytics</h1>
</a></article>

        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="scrum-club-day-3-release-planning.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">Scrum Club - Day 3: Release Planning</h1>
</a></article>

    </aside>

    <aside class="related-articles related-articles--author" role="complementary" itemscope itemtype="http://schema.org/WPSideBar">
      <h2 class="related-articles__heading">More by Juho Vähä-Herttua</h2>
        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="time-is-the-fire-in-which-we-burn.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">Time Is the Fire in Which We Burn</h1>
</a></article>

        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="broken-uitableviewcontroller-initializer-in-swift.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">Broken UITableViewController initializer in Swift</h1>
</a></article>

        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="build-environment-like-its-1986.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">Build environment like it&#x27;s 1986</h1>
</a></article>

    </aside>

</div>


  </main>
  
<footer class="footer" role="contentinfo" itemscope itemtype="http://schema.org/WPFooter">
    <div class="follow-us">
      <h3 class="follow-us__heading">Follow us:</h3>

        <a href="https://www.facebook.com/futurice" class="follow-us__link follow-us__link--facebook" target="_blank">
          <img alt="Facebook" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>        <a href="https://twitter.com/futurice" class="follow-us__link follow-us__link--twitter" target="_blank">
          <img alt="Twitter" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>        <a href="https://www.instagram.com/futurice" class="follow-us__link follow-us__link--instagram" target="_blank">
          <img alt="Instagram" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>                                <a href="http://vimeo.com/futurice" class="follow-us__link follow-us__link--vimeo" target="_blank">
          <img alt="Vimeo" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>                                                <a href="https://github.com/futurice" class="follow-us__link follow-us__link--github" target="_blank">
          <img alt="Github" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>                        
    </div>
  <div class="footer__padding">
    <div class="footer__logo">
      <a href="../index.html">
        <img alt="Futurice" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/futurice-logo--white.png';" src="http://static.flockler.com/assets/futurice/images/futurice-logo--white.svg" />
</a>
      <p class="footer__tagline">We create digital services for people&nbsp;to&nbsp;love</p>
    </div>

    <div class="footer__menu">
      <hr>
      <p>
        <a href="../work.html">Work</a>
        <a href="../culture.html">Culture</a>
        <a href="../careers.html">Careers</a>
        <a href="../people.html">People</a>
        <a href="../blog.html">Blog</a>
        <a href="../contact.html">Contact</a>
      </p>
    </div>
    <div class="footer__menu">
      <hr>
      <p>
        <a href="../contact.html#helsinki" class="js-contact-location">Helsinki</a>
        <a href="../contact.html#berlin" class="js-contact-location">Berlin</a>
        <a href="../contact.html#london" class="js-contact-location">London</a>
        <a href="../contact.html#tampere" class="js-contact-location">Tampere</a>
        <a href="../contact.html#stockholm" class="js-contact-location">Stockholm</a>
        <a href="../contact.html#munich" class="js-contact-location">Munich</a>
      </p>
    </div>

    <div class="footer__details">
      <span>&copy; 2016 Futurice. All Rights Reserved</span>
      <a href="../legal-disclaimer.html">Legal disclaimer</a>
      <a href="../impressum.html">Impressum</a>
      <a href="../datenschutz.html">Datenschutz</a>
    </div>

  </div>
</footer>

  <form id="load-more-state-form" style="overflow:hidden;width:1px;height:1px;margin:0;padding:0;position:absolute;bottom:0;">
  <input id="load-more-state" type="checkbox" tabindex="-1" aria-hidden="true">
</form>


  <script>
    var Futurice = {
      siteId: 377,
      itemsPerPage: 8
    };
    var APIBASEPATH = "https://flockler.com/api";
  </script>

  <script src="../../static.flockler.com/assets/futurice/javascripts/application-689c6d006591a03af50a5a56fc93ce18.js" type="text/javascript"></script>
  <!--[if IE 8 ]>
<link href="//static.flockler.com/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/respond.proxy.js"></script>
<![endif]-->


  <aside class="cookie-notice js-cookie-notice">
  <p class="cookie-notice__description">
    By continuing to use this site, you agree to the use of cookies.
    You can change this and find out more by following&nbsp;this&nbsp;<a href="../cookies.html">link</a>.
  </p>
  <button type="button" class="cookie-notice__button js-cookie-notice__button">Accept cookies</button>
</aside>


    <!-- Start of Async HubSpot Analytics Code -->
    <script type="text/javascript">
      (function(d,s,i,r) {
        if (d.getElementById(i)){return;}
        var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
        n.id=i;n.src='//js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/553433.js';
        e.parentNode.insertBefore(n, e);
      })(document,"script","hs-analytics",300000);
    </script>
    <!-- End of Async HubSpot Analytics Code -->
</body>

<!-- Mirrored from futurice.com/blog/id-like-to-have-some-lcd-on-my-pi by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 14 Apr 2016 08:27:04 GMT -->
</html>
