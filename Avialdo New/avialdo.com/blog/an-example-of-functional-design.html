<!DOCTYPE html>
<html lang="en">
<!--

  Want to apply for a developer job? Follow this path: http://challenge.futurice.com/

-->

<!-- Mirrored from futurice.com/blog/an-example-of-functional-design by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 14 Apr 2016 08:10:24 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head prefix="og: http://ogp.me/ns#">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <!--[if lt IE 9]><script src="//static.flockler.com/assets/html5shiv/html5shiv-3.7.2-411c036062e933ea2996a9e81d0a1a10.js" type="text/javascript"></script><![endif]-->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0"/>
  <link rel="alternate" type="application/rss+xml" title="Futurice Blog" href="rss">

  <title>An example of functional design — Futurice</title>
  <link rel="icon" type="image/png" href="../../static.flockler.com/assets/futurice/images/favicon-73ef94531581d9f27e41233515c60919.png">
  <!--[if IE]>
    <link rel="shortcut icon" href="//static.flockler.com/assets/futurice/images/favicon-3225e8217799f7ff156f47c394d9eb67.ico"/>
  <![endif]-->

  
  <meta property="og:title" content="An example of functional design — Futurice">
  <meta property="og:description" name="description" content="TL;DR this is not a monad tutorial

In this blog post we&amp;#39;ll walk through the technical design of one part of a (not yet public nor completed) web application made by Futurice. The library in focus is named jobba, and is very similar to Facebook&amp;#3">
  <meta property="og:type" content="article">
  <meta property="og:url" content="an-example-of-functional-design.html">
  <meta property="og:image" content="../../flockler.com/thumbs/1992/header_s1200x630_c1628x952_l0x31_noupscale.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">


  <script src="../../use.typekit.net/yvs3xkq.js"></script>
  <script>try{Typekit.load();}catch(e){}</script>

  <link href="../../static.flockler.com/assets/futurice/stylesheets/application-c89517cc680dd524a0b43dc0e8f7f8ce.css" media="screen" rel="stylesheet" type="text/css" />

</head>
<body class="view--articles view--articles-show is-article-view is-blog-post-view" itemscope itemtype="http://schema.org/WebPage">
  <!-- Google Tag Manager -->
<noscript><iframe src="http://www.googletagmanager.com/ns.html?id=GTM-M2CWVJ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'../../www.googletagmanager.com/gtm5445.html?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-M2CWVJ');</script>
<!-- End Google Tag Manager -->

<div style="display:none">
  <!-- Google Code for Remarketing Tag -->
  <script type="text/javascript">
  /* <![CDATA[ */
    var google_conversion_id = 997302464;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
  /* ]]> */
  </script>
  <script type="text/javascript" src="../../www.googleadservices.com/pagead/f.txt"></script>
  <noscript><div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="http://googleads.g.doubleclick.net/pagead/viewthroughconversion/997302464/?value=0&amp;guid=ON&amp;script=0"/></div></noscript>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','../../www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15911025-14', 'auto', {'name': 'flocklerInternal'});
  ga('flocklerInternal.html', 'forceSSL', true);
  ga('flocklerInternal.send', 'pageview');
</script>


  <nav class="nav" role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
  <div class="nav__padding">
    <a href="../index.html" class="nav__logo-link">
      <img alt="Futurice" class="nav__logo" onerror="this.onerror=null;this.src='../assets/futurice/images/futurice-logo--green.png';" src="http://static.flockler.com/assets/futurice/images/futurice-logo--green.svg" />
</a>    <div class="nav-collapse">
      <ul class="nav__items">
        <li class="nav__item">
          <a href="../work.html">Work</a>
        </li>
        <li class="nav__item">
          <a href="../services.html">Services</a>
        </li>
        <li class="nav__item">
          <a href="../culture.html">Culture</a>
        </li>
        <li class="nav__item">
          <a href="../careers.html">Careers</a>
        </li>
        <li class="nav__item">
          <a href="../events.html">Events</a>
        </li>
        <li class="nav__item">
          <a href="../people.html">People</a>
        </li>
        <li class="nav__item">
          <a href="../blog.html">Blog</a>
        </li>
        <li class="nav__item">
          <a href="../contact.html">Contact</a>
        </li>
        <li class="nav__item nav__item--search">
          <a href="../search.html"><i class="icon-search"></i><span>Search</span></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <header class="header" role="banner" itemscope itemtype="http://schema.org/WPHeader">
  <div class="header__container">
    <img alt="Bg-4" onerror="this.onerror=null;this.src='../assets/futurice/images/backgrounds/bg-4.png';" src="http://static.flockler.com/assets/futurice/images/backgrounds/bg-4.svg" />

  </div>
</header>

  <main class="main" role="main" itemscope itemprop="mainContentOfPage" itemtype="http://schema.org/WebPage">
    
  <div class="article-wrapper">
  <article class="article" itemscope itemprop="blogPost" itemtype="http://schema.org/BlogPosting">
    <header class="article__header">
      <div class="article__header__meta">
        <time class="article__header__meta__published-at" itemprop="datePublished" datetime="2014-12-11T12:55:56Z">
          December 11, 2014
        </time>
          <span class="article__header__meta__category" itemprop="articleSection">
            Software development
          </span>
      </div>

      <h1 class="article__header__title" itemprop="headline">
        An example of functional design
      </h1>

      <div class="article__header__meta">
          <div class="article__header__meta__item article__header__author" itemprop="author" itemscope itemptype="http://schema.org/Person">
              <a href="../people/oleg-grenrus.html" class="article__header__author-link" itemprop="url" rel="author">
                <figure class="article__header__author__avatar">
                  <img alt="" src="../../flockler.com/thumbs/sites/377/tuimaoleg-nelio_s100x100_q80_noupscale.png" />
                </figure>
                <div class="article__header__meta__item__body">
                  <span class="article__header__author-name" itemprop="name">Oleg Grenrus</span>
                  <span class="article__header__author-title" itemprop="jobTitle">Software developer</span>
                </div>
              </a>
          </div>

      </div>
    </header>
    <div class="article__body" itemprop="articleBody">
      <p><span><strong>TL;DR</strong><span> </span><em>this is not a monad tutorial</em></span></p>

<p dir="ltr"><span><span>In this blog post we'll walk through the technical design of one part of a (not yet public nor completed) web application made by Futurice. The library in focus is named </span><em>jobba</em><span>, and is very similar to </span><a href="https://code.facebook.com/posts/302060973291128/open-sourcing-haxl-a-library-for-haskell/"><span>Facebook's Haxl</span></a><span> and </span><a href="http://www.youtube.com/watch?v=VVpmMfT8aYw"><span>Twitter's Stitch</span></a><span>. Using jobba we can fetch resources from backend servers in a functional way. Unfortunately </span><em>jobba</em><span> isn't open sourced (neither is Stitch), but at least this "documentation" is public now.</span></span></p>

<h2 class="article__heading--h2">Is Future functional?</h2>

<p dir="ltr"><span><span>To access backend resources, we could build a small library using Scala’s </span><span>Future</span><span> directly. But is Scala's </span><span>Future</span><span> (or JavaScript's Promises) functional? This question is immediately followed by a meta-question: What do we mean by "functional"? If functional means that we have </span><span>map</span><span>, </span><span>filter</span><span> and </span><span>reduce</span><span>, then — yes — </span><span>Future</span><span> is a functional construct. Yet the defining property of functional programs is the referential transparency, a property which enables us to reason equationally. Fancy words need examples:</span></span></p>

<p dir="ltr"><span><span>If we start with a very simple example</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def f(b: Boolean): Int = ???
val a: List[Int] = List(true, false, true) map (f _)</code></pre>

<p dir="ltr"><span><span>and ask ourselves, are the first and the third elements of the list </span><span>l</span><span> the same? If </span><span>f</span><span> is referentially transparent then we'll have</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">val a: List[Int] = List(f(true), f(false), f(true))</code></pre>

<p dir="ltr"><span><span>and the answer is: yes, as<em> </em></span><em><span>f(true) == f(true)</span></em><span><em> </em>always. Scala doesn't enforce referential transparency, so we can't be a hundred percent sure. But most likely, functions from Booleans to Ints are referentially transparent.</span></span></p>

<p dir="ltr"><span><span>But can we reason similarly about a program involving Futures?</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def g(b: Boolean): Future[Int] = if (b) foo else bar
def b: Future[List[Int]] = Future.traverse(List(true, false, true)) (g _)</code></pre>

<p dir="ltr"><span><span>Can we be sure that, in the resulting list, the first and third values will always be the same (if </span><span>b</span><span> resolves successfully)? This is a trick question: the answer is “it depends”. If we manually evaluate the expression:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">Future.traverse(List(true, false, true)) (g _) ≡
Future.sequence(List(true, false, true) map (g _)) ≡
Future.sequence(List(g(true), g(false), g(true))) ≡
Future.sequence(List(foo, bar, foo))</code></pre>

<p dir="ltr"><span><span>we see that the first and the third elements </span><em>should</em><span> be the same, and they will be if </span><span>foo</span><span> is a </span><span>val</span><span>. But if </span><span>foo</span><span> is defined as </span><em><span>def foo = webClient.get("http://my.backend/api/foo")</span></em><span>, then not only may the results vary, but two requests will be made to the same endpoint. And contrary to the previous example, Future-computations usually </span><strong>do</strong><span> have these kinds of side effects.</span></span></p>

<p dir="ltr"><span><span>In this small example the issue is easy to work around. But try to imagine a larger system, with a very granular backend API, where one has to make hundreds of backend requests to compose the final result. Let's take Twitter as an example: you can fetch a user's feed, where each tweet has an author, and you can fetch each author's information, to get an avatar URL. You'd like the rendered feed (the result) to be consistent, i.e. each author always has the same avatar. Or going even further: you'd like to make as few backend requests as possible. Your API might even support fetching multiple users' information with a single request. You'd like to leverage that, but you don't want to sacrifice the clarity of your code. So you could take it all into account manually:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def usersFeed(userHandle: UserHandle)(implicit ec: ExecutionContext): Future[Html] =
 for {
   feed &lt;- fetchFeed(userHandle)
   usersData &lt;- fetchUsersData(feed.uniqueUserHandles)
 } yield renderFeed(feed, usersData)</code></pre>

<p dir="ltr"><span><span>And that's ok. But then you'd like to render two users' feeds on top of each other. If you do</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def twoUsersFeed(a: UserHandle, b: UserHandle)(implicit ec: ExecutionContext): Future[Html] =
 for {
   feedA &lt;- usersFeed(a)
   feedB &lt;- usersFeed(b)
 } yield feedA ++ feedB</code></pre>

<p dir="ltr"><span><span>you lose the desired property: consistent results (the referential transparency). Also you lose the property of making as few requests as possible. It is difficult to use multi-valued requests and have composable code.</span></span></p>

<p dir="ltr"><span><span>Rather you'd like to write more granular code, and have the above properties:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def singleTweet(tweet: Tweet)(implicit ec: ExecutionContext): Future[Html] =
 for {
   author &lt;- fetchUser(tweet.author)
 } yield renderTweet(tweet, author)

def usersFeed(userHandle: UserHandle)(implicit ec: ExecutionContext): Future[Html] =
 for {
   feed &lt;- fetchFeed(userHandle)
   renderedTweets &lt;- Future.traverse (feed.tweets) (singleTweet _)
 } yield renderFeed(feed, renderedTweets)</code></pre>

<h2 class="article__heading--h2">The solution — Functional Future</h2>

<p dir="ltr"><span><span>How to proceed is actually quite obvious, if you are familiar with the common FP design practices. The </span><span>Future</span><span> isn't a pure construction, but merely a functional looking wrapper to side-effectful callback-based operations. The </span><span>Future</span><span> isn't composable in the way we want it to be. We want to separate the </span><em>what</em><span> and the </span><em>how</em><span> of backend access. Let frontend developers specify </span><em>what</em><span> to fetch and </span><em>what </em><span>to do with results, and backend developers </span><em>how</em><span> to fetch it. Plain </span><span>Future</span><span> doesn't work, so we just add another level of abstraction by introducing a new type, </span><span>Job</span><span>:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">// "frontend"
def singleTweet(tweet: Tweet): Job[Html] =
 for {
   author &lt;- fetchUser(tweet.author)
 } yield renderTweet(tweet, author)

def usersFeed(userHandle: UserHandle): Job[Html] =
 for {
   feed &lt;- fetchFeed(userHandle)
   renderedTweets &lt;- Job.traverse (feed.tweets) (singleTweet _)
 } yield renderFeed(feed, renderedTweets)

// "backend"
package object executor {
 def execute[T](job: Job[T])(implicit ec: ExecutionContext): Future[T] = ???
}</code></pre>

<p dir="ltr"><span><span>Here we already implicitly decided that the </span><span>Job</span><span> and </span><span>Future</span><span> API should be similar. The difference is that, we first construct a </span><span>Job</span><span> computation and then execute it. This is contrary to </span><span>Future</span><span>, where construction and execution are highly interleaved.</span></span></p>

<p dir="ltr"><span><span>With the separation of construction and execution, frontend / application developers could compose Jobs (specify the </span><em>what</em><span>). Backend developers could work on the implementation of the </span><span>execute</span><span> method — the </span><em>how</em><span>. The implementation will be written in a referentially transparent way, also automatically optimising the execution.</span></span></p>

<p dir="ltr"><span><span>What is the trick, one might ask? It’s the primitive building blocks. With </span><span>Future</span><span> you could do virtually everything, but with </span><span>Job</span><span> you can only ask for a JSON document from the backend. By restricting what a </span><span>Job</span><span> can do, the implementation can be made fully referentially transparent, as explained later.</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">object Future {
 def apply[T](body: =&gt; T)(implicit ec: ExecutionContext): Future[T]
}

object Job {
 def fetch[T](url: Url)(implicit reads: Reads[T]): Job[T]
}

val f = Future { launchNuclearMissiles() }
val j = Job.fetch[JsValue]("https://api.github.com/orgs/futurice")</code></pre>

<h2 class="article__heading--h2">Comparison of Jobba to Haxl and Stitch</h2>

<p dir="ltr"><span><span>Jobba, Haxl, and Stitch are very similar libraries. Yet there are a couple of differences worth pointing out, if you are already familiar with them.</span></span></p>

<p dir="ltr"><span><span>Haxl is a Haskell library by Facebook with which you can:</span></span></p>

<ul>
	<li>
	<p dir="ltr"><span><span>Make concurrency implicit using Applicative Functors</span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>Get soundness and modularity for free from implicit caching</span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>Concurrently fetch data from multiple heterogeneous sources</span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>Implicitly batch multiple requests to the same data source into a single request</span></span></p>
	</li>
</ul>

<p dir="ltr"><span><span>Stitch is a Scala library by Twitter with which you can do almost the same:</span></span></p>

<ul>
	<li>
	<p dir="ltr"><span><span>Make concurrency implicit using Applicative Functors</span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span><em><strong>Don't </strong></em>get soundness and modularity for free from implicit caching</span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>Concurrently fetch data from multiple heterogeneous sources</span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>Implicitly batch multiple requests to the same data source into a single request</span></span></p>
	</li>
</ul>

<p dir="ltr"><span><span>Unluckily Stitch isn't open source. And it doesn't have </span><em>the</em><span> </span><em>soundness and modularity</em><span> property, which is another way to say that the execution is referentially transparent. So there are already three reasons to make our own library: we use scala (rules out Haxl), want referential transparency and a library we can use (rules out Stitch).</span></span></p>

<p dir="ltr"><span><span>Also our environment was a bit simpler. We didn't have a batch API, and we have only a single source type: JSON over HTTP. And we take advantage of that, as it simplifies internals. So Jobba is a Scala library by us with which you can:</span></span></p>

<ul>
	<li>
	<p dir="ltr"><span><span>Make concurrency implicit using Applicative Functors</span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>Get soundness and modularity for free from implicit caching</span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>Concurrently fetch data from</span><span> </span><strong><em>single</em></strong><span> heterogenous source</span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>Implicitly batch multiple requests to the same data source into a single request</span></span></p>
	</li>
</ul>

<h2 class="article__heading--h2"><span><span>Here be dragons</span></span></h2>

<p dir="ltr"><span><span>The implementation of </span><span>Job</span><span> uses the same approach as Haxl or Stitch: </span><a href="http://programmers.stackexchange.com/questions/242795/what-is-the-free-monad-interpreter-pattern"><em>Free Monad</em></a><span>. There are good explanations of </span><a href="http://stackoverflow.com/questions/13352205/what-are-free-monads"><span>free monads and free structures in general on StackOverflow</span></a><span>, so I won't repeat them.</span></span></p>

<p dir="ltr"><span><span>The idea is to make a data type that has all the needed operations, but doesn't perform anything. Then the executor (evaluator or interpreter) will take the description of the computation and execute it.</span></span></p>

<p dir="ltr"><span><span>This problem is quite similar to the </span><em><span>Par</span></em><span> example in Chapter 4 of </span><a href="http://www.manning.com/bjarnason/"><span>Functional Programming in Scala</span></a><span>. We abstract even more, though. Using free monads we could have totally different implementations of our </span><span>execute</span><span> method. In the Par example, the authors had to change the definition of the </span><span>Par</span><span> data type to provide a fully non-blocking </span><span>Par</span><span> implementation using actors.</span></span></p>

<p dir="ltr"><span><span>One simple definition of </span><span>Job</span><span> could be:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">sealed trait Job[+T]
case class PureJob[T](value: T) extends Job[T]
case class BlockedJob[S,T](f: S =&gt; Job[T], job: Job[S]) extends Job[T]
case class FetchJob[T](url: Url, reads: Reads[T]) extends Job[T]</code></pre>

<p dir="ltr"><span><span>Then we could implement the primitive operations of the Job API:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def flatMap[S,T](f: S =&gt; Job[T], job: Job[S]): Job[T] =
 job match {
   case PureJob(value) =&gt; f(value)
   case _              =&gt; BlockedJob(f, job)
 }

def pure[T](value: T) =
 PureJob(value)

def map[S, T](f: S =&gt; T, job: Job[S]): Job[T] =
 job match {
   case PureJob(value) =&gt; PureJob(f(value))
   case _              =&gt; BlockedJob((x: S) =&gt; pure(f(x)), job)
 }

def fetch[T](url: Url)(implicit reads: Reads[T]): Job[T] =
 FetchJob(url, reads)</code></pre>

<p dir="ltr"><span><span>Here we already perform some local optimisations of the syntax structure we build up.</span></span></p>

<p dir="ltr"><span><span>Unfortunately, to make for-comprehensions work, we need to define </span><span>map</span><span> and </span><span>flatMap</span><span> as member methods of </span><span>Job</span><span>. So the real definition of the </span><span>Job</span><span> trait is more interleaved:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">sealed trait Job[+T] {
 def flatMap[S](f: T =&gt; Job[S]): Job[S] =
   BlockedJob(f, this)

 def map[S](f: T =&gt; S): Job[S] =
   BlockedJob[T, S]((x: T) =&gt; PureJob(f(x)), this)
}

case class PureJob[T](value: T) extends Job[T] {
 override def flatMap[S](f: T =&gt; Job[S]): Job[S] =
   f(value)

 override def map[S](f: T =&gt; S): Job[S] =
   PureJob(f(value))
}
case class BlockedJob[S,T](f: S =&gt; Job[T], job: Job[S]) extends Job[T]
case class FetchJob[T](url: Url, reads: Reads[T]) extends Job[T]</code></pre>

<p dir="ltr"><span><span>After we have defined the </span><span>Job</span><span> data structure, we could look what the </span><span>singleTweet</span><span> Job will look like:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">scala&gt; singleTweet(Tweet("phadej", "fun prog is fun"))
res0: Job[Html] = BlockedJob(&lt;function1&gt;,FetchJob(/user/phadej,()))
</code></pre>

<p dir="ltr"><span><span>As </span><span>map</span><span> is implemented using </span><span>flatMap</span><span> we see a </span><span>BlockedJob</span><span> as an outer constructor of the resulting job. </span><span>&lt;function1&gt;</span><span> is an anonymous unary function we make in </span><span>flatMap</span><span>.</span></span></p>

<p dir="ltr"><span><span>Next, let's write a simple executor, we simply squash </span><span>Job</span><span> into </span><span>Future</span><span>, </span><span>PureJob</span><span> into </span><span>Future.successful</span><span> and </span><span>BlockedJob</span><span> into </span><span>Future.flatMap</span><span>:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def execute[T](job: Job[T])(implicit ec: ExecutionContext): Future[T] =
 job match {
   case PureJob(value)       =&gt; Future.successful(value)
   case BlockedJob(f, job)      =&gt; execute(job) flatMap { value =&gt; execute(f(value)) }
   case FetchJob(url, reads) =&gt; ???
 }
</code></pre>

<p dir="ltr"><span>The execution of </span><span>FetchJob</span><span> is the place where the magic starts to happen. We could simply perform the actual fetch for every </span><span>FetchJob</span><span>, but what we really do is we cache </span><span>FetchJobs</span><span> as we go:</span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def execute[T](job: Job[T])(implicit cache: FetchCache, ec: ExecutionContext): Future[T] =
 job match {
   case PureJob(value)       =&gt; Future.successful(value)
   case BlockedJob(f, job)   =&gt; execute(job) flatMap { value =&gt; execute(f(value)) }
   case FetchJob(url, reads) =&gt; cache.cached(url, reads) { webClient.get(url)(reads) }
 }</code></pre>

<p dir="ltr"><span><span>Using this we get soundness and modularity. Yet skeptics will notice that we could rewrite the original </span><span>singleTweet</span><span> as:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def singleTweet(tweet: Tweet)(implicit cache: FetchCache, ec: ExecutionContext): Future[Html] =
 for {
   author &lt;- fetchUser(tweet.author)
 } yield renderTweet(tweet, author)</code></pre>

<p dir="ltr"><span><span>or</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">implicit def jobba2execution(implicit ctx: JobbaContext): ExecutionContext = ???

def singleTweet(tweet: Tweet)(implicit ctx: JobbaContext): Future[Html] =
 for {
   author &lt;- fetchUser(tweet.author)
 } yield renderTweet(tweet, author)</code></pre>

<p dir="ltr"><span><span>and get the same benefits. And that is very true. For example in our application we have three caches: app-global in-memory, </span><a href="http://redis.io/"><span>Redis</span></a><span> cache for backend responses, and request-local in-memory cache for consistency. All these three could be implemented using an implicit context, as they only affect how a </span><span>fetch</span><span> operation is performed.</span></span></p>

<p dir="ltr"><span><span>The </span><span>type <em>Job[+A] = JobbaContext =&gt; Future[A]</em></span><span> definition, which resembles the </span><em><span>Par</span></em><span> implementation, would work as well as the implicit contexts: not well enough.</span></span></p>

<h2 class="article__heading--h2"><span><span>Why not just use implicit context</span></span></h2>

<p class="article__paragraph" dir="ltr"><span><span>Using Futures directly, and implicits, we cannot affect the structure of the computation. We can't change the structure of the computation built with Futures. We can't bundle multiple fetches into one, to e.g. leverage </span><a href="http://redis.io/commands/mget"><span>Redis' MGET</span></a><span> command. To achieve that, we must make the Job structure richer and add a few more job-types:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">sealed trait Job[+T] {
 def flatMap[S](f: T =&gt; Job[S]): Job[S] = BlockedJob(f, this)
 def map[S](f: T =&gt; S): Job[S] = MapJob(f, this)
}
case class MapJob[S, T](f: S =&gt; T, job: Job[S]) extends Job[T]
case class PairJob[S, T](jobS: Job[S], jobT: Job[T]) extends Job[(S, T)]
/* PureJob, BlockedJob and FetchJob as previously */</code></pre>

<p dir="ltr"><span><span>The </span><span>MapJob</span><span> is quite simple: it's there to expose the </span><span>map</span><span> operation directly, not via </span><span>pure</span><span> and </span><span>flatMap</span><span>. The </span><span>PairJob</span><span> needs more explanation. If we continue with a simpler Job definition for a moment, and try to build a concurrent </span><span>Job</span><span>:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def twoTweets(a: Tweet, b: Tweet): Job[Html] =
 for {
   htmlA &lt;- singleTweet(a)
   htmlB &lt;- singleTweet(b)
 } yield htmlA ++ htmlB

scala&gt; twoTweets(Tweet("phadej", "fun prog is fun"), Tweet("futurice", "RT @phadej fun prog is fun"))
res1: Job[Html] = BlockedJob(&lt;function1&gt;,BlockedJob(&lt;function1&gt;,FetchJob(/user/phadej,())))
</code></pre>

<p dir="ltr"><span><span>Here we would expect to see </span><em><span>FetchJob(/user/futurice)</span></em><span> too, as clearly we could perform both fetches concurrently, or even bundled into one. Applicative Functors come to the rescue. We need to modify the </span><span>twoTweets</span><span> definition (using </span><a href="https://github.com/scalaz/scalaz"><span>scalaz</span></a><span> magical operators):</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">def applicativeTwoTweets(a: Tweet, b: Tweet): Job[Html] =
 (singleTweet(a) |@| singleTweet(b)) { (htmlA, htmlB) =&gt; htmlA ++ htmlB }</code></pre>

<p dir="ltr"><span><span>Using this we actually do worse at first:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">scala&gt; applicativeTwoTweets(Tweet("phadej", "fun prog is fun"), Tweet("futurice", "RT @phadej fun prog is fun"))
res0: Job[Html] = BlockedJob(&lt;function1&gt;,BlockedJob(&lt;function1&gt;,BlockedJob(&lt;function1&gt;,FetchJob(/user/phadej,()))))
</code></pre>

<p dir="ltr"><span><span>Let's define </span><span>ap</span><span> in Applicative using </span><span>PairJob</span><span>, i.e. remember that we composed Jobs applicatively. Then we'll see more of the computation's original structure:</span></span></p>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">scala&gt; applicativeTwoTweets(Tweet("phadej", "fun prog is fun"), Tweet("futurice", "RT @phadej fun prog is fun"))
res0: Job[Html] =
 MapJob(&lt;function1&gt;,PairJob(
   MapJob(&lt;function1&gt;,FetchJob(/user/futurice,())),
   MapJob(&lt;function1&gt;,FetchJob(/user/phadej,()))))</code></pre>

<p dir="ltr"><span><span>At this point we can redo the executor — totally change its execution strategy. Make it first traverse the job structure, picking up all visible FetchJobs. Then we can bundle fetches together into a single Redis MGET command. After that, replace FetchJobs with results wrapped into PureJobs, simplify the structure of the job and loop, until we have only a single </span><span>PureJob</span><span> at hand! We call this executor </span><em>OnionExecutor</em><span>, because it </span><em>peels</em><span> the structure off, making the job smaller and smaller at every iteration.</span></span></p>

<p dir="ltr"><span><span>Let's work the two tweets job step-by-step:</span></span></p>

<ul>
	<li>
	<p dir="ltr"><span><span>we see two </span><span>FetchJob</span><span>s:<em> /user/futurice</em> and <em>/user/phadej</em></span></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>next we bundle them together into single MGET, which hopefully returns us two values: </span><em><span>futurice</span></em><span> and </span><em><span>phadej</span></em></span></p>
	</li>
	<li>
	<p dir="ltr"><span><span>after that we substitute the values into the job we started with:</span></span></p>
	</li>
</ul>

<pre class="article__code CodeRay CodeRay-- CodeRay--unknown-lang">
<code data-lang="">res0: Job[Html] =
 MapJob(&lt;function1&gt;,PairJob(
   MapJob(&lt;function1&gt;,PureJob(&lt;Author futurice&gt;)),
   MapJob(&lt;function1&gt;,PureJob(&lt;Author phadej))))</code></pre>

<ul>
	<li>
	<p dir="ltr"><span><span>in this job we don't have anything </span><em>blocking</em><span> our computation, so we can reduce it into the final </span><span>Html</span><span>!</span></span></p>
	</li>
</ul>

<p dir="ltr"><span><span>There weren't any </span><span>BlockedJob</span><span>s in the example job above. That means that we could render these two tweets using a single iteration of the executor loop, a single MGET — as we did!</span></span></p>

<p dir="ltr"><span><span>In the real version of </span><span>Job</span><span> we also have </span><span>FailedJob, because sometimes things go wrong, but that's all.</span></span></p>

<h2 class="article__heading--h2"><span><span>Conclusion</span></span></h2>

<p dir="ltr"><span><span>Above I showed you how one can construct a powerful computation abstraction using free structures. Essentially we made an embedded language (which in turn embeds a host language to do pure computations!) to do asynchronous resource retrievals. We have more control over the execution than when using Futures directly and more importantly the execution strategy, we used, is referentially transparent. We can also add more primitives if we need them.</span></span></p>

<p><br>
 </p>

    </div>

    <footer class="article__footer">
      <span class="article__footer__item article__author" itemprop="author" itemscope itemptype="http://schema.org/Person">
        <span class="article__footer__item__label">Written by</span>
        <div class="article__footer__item__body">
            <a href="../people/oleg-grenrus.html" class="article__author-link" itemprop="url" rel="author">
              <span class="article__author-name" itemprop="name">Oleg Grenrus</span>
            </a>
        </div>
      </span>

      <span class="article__footer__item article__footer__item--share">
  <span class="article__footer__item__label">Share</span>
  <div class="article__footer__item__body">

    <a onClick="event.preventDefault(); window.open('http://www.facebook.com/sharer.php?u=http%3A%2F%2Ffuturice.com%2Fblog%2Fan-example-of-functional-design', 'sharer', 'toolbar=0,status=0,width=548,height=325');" target="_blank"  class="article__footer__item__share-link" href="http://www.facebook.com/sharer.php?u=http%3A%2F%2Ffuturice.com%2Fblog%2Fan-example-of-functional-design">
      <i class="icon-facebook"></i>
    </a>

    <a onClick="event.preventDefault(); window.open('https://twitter.com/intent/tweet?text=An%20example%20of%20functional%20design&amp;url=http%3A%2F%2Ffuturice.com%2Fblog%2Fan-example-of-functional-design', 'sharer', 'toolbar=0,status=0,width=548,height=525');" target="_blank" class="article__footer__item__share-link"
    href="https://twitter.com/intent/tweet?text=An%20example%20of%20functional%20design&amp;url=http%3A%2F%2Ffuturice.com%2Fblog%2Fan-example-of-functional-design">
      <i class="icon-twitter"></i>
    </a>

    <a onClick="event.preventDefault(); window.open('https://plus.google.com/share?url=http%3A%2F%2Ffuturice.com%2Fblog%2Fan-example-of-functional-design', 'sharer', 'toolbar=0,status=0,width=548,height=525');" target="_blank" class="article__footer__item__share-link"
    href="https://plus.google.com/share?url=http%3A%2F%2Ffuturice.com%2Fblog%2Fan-example-of-functional-design">
      <i class="icon-google-plus"></i>
    </a>

    <a onClick="event.preventDefault(); window.open('https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Ffuturice.com%2Fblog%2Fan-example-of-functional-design&amp;title=An%20example%20of%20functional%20design', 'sharer', 'toolbar=0,status=0,width=548,height=525');" target="_blank" class="article__footer__item__share-link"
    href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Ffuturice.com%2Fblog%2Fan-example-of-functional-design&amp;title=An%20example%20of%20functional%20design">
      <i class="icon-linkedin"></i>
    </a>
  </div>
</span>

    </footer>
  </article>

    <aside class="related-articles related-articles--tag" role="complementary" itemscope itemtype="http://schema.org/WPSideBar">
      <h2 class="related-articles__heading">More to read</h2>
        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="biology-is-the-new-digital-and-other-iot-insights-from-solidcon.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">Biology is The New Digital and Other takeaways from O&#x27;Reilly Solid IoT event</h1>
</a></article>

        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="lean-startup-and-management-3-dot-0-courses.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">Lean Startup and Management 3.0 courses!</h1>
</a></article>

        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="elm-in-the-real-world.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">How Elm made our work better</h1>
</a></article>

    </aside>

    <aside class="related-articles related-articles--author" role="complementary" itemscope itemtype="http://schema.org/WPSideBar">
      <h2 class="related-articles__heading">More by Oleg Grenrus</h2>
        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="npm-registry-in-numbers.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">NPM registry in numbers</h1>
</a></article>

        
<article class="article-list-item "
  itemscope itemprop="article" itemtype="http://schema.org/article">
  <a href="tech-pick-of-the-week-jsstana.html" class="article-list-item__link" itemprop="url">
    <h1 class="article-list-item__title" itemprop="headline">Tech Pick of the Week: jsstana</h1>
</a></article>

    </aside>

</div>


  </main>
  
<footer class="footer" role="contentinfo" itemscope itemtype="http://schema.org/WPFooter">
    <div class="follow-us">
      <h3 class="follow-us__heading">Follow us:</h3>

        <a href="https://www.facebook.com/futurice" class="follow-us__link follow-us__link--facebook" target="_blank">
          <img alt="Facebook" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>        <a href="https://twitter.com/futurice" class="follow-us__link follow-us__link--twitter" target="_blank">
          <img alt="Twitter" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>        <a href="https://www.instagram.com/futurice" class="follow-us__link follow-us__link--instagram" target="_blank">
          <img alt="Instagram" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>                                <a href="http://vimeo.com/futurice" class="follow-us__link follow-us__link--vimeo" target="_blank">
          <img alt="Vimeo" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>                                                <a href="https://github.com/futurice" class="follow-us__link follow-us__link--github" target="_blank">
          <img alt="Github" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/some-icons.png';" src="http://static.flockler.com/assets/futurice/images/some-icons.svg" />
</a>                        
    </div>
  <div class="footer__padding">
    <div class="footer__logo">
      <a href="../index.html">
        <img alt="Futurice" data-pin-no-hover="true" onerror="this.onerror=null;this.src='../assets/futurice/images/futurice-logo--white.png';" src="http://static.flockler.com/assets/futurice/images/futurice-logo--white.svg" />
</a>
      <p class="footer__tagline">We create digital services for people&nbsp;to&nbsp;love</p>
    </div>

    <div class="footer__menu">
      <hr>
      <p>
        <a href="../work.html">Work</a>
        <a href="../culture.html">Culture</a>
        <a href="../careers.html">Careers</a>
        <a href="../people.html">People</a>
        <a href="../blog.html">Blog</a>
        <a href="../contact.html">Contact</a>
      </p>
    </div>
    <div class="footer__menu">
      <hr>
      <p>
        <a href="../contact.html#helsinki" class="js-contact-location">Helsinki</a>
        <a href="../contact.html#berlin" class="js-contact-location">Berlin</a>
        <a href="../contact.html#london" class="js-contact-location">London</a>
        <a href="../contact.html#tampere" class="js-contact-location">Tampere</a>
        <a href="../contact.html#stockholm" class="js-contact-location">Stockholm</a>
        <a href="../contact.html#munich" class="js-contact-location">Munich</a>
      </p>
    </div>

    <div class="footer__details">
      <span>&copy; 2016 Futurice. All Rights Reserved</span>
      <a href="../legal-disclaimer.html">Legal disclaimer</a>
      <a href="../impressum.html">Impressum</a>
      <a href="../datenschutz.html">Datenschutz</a>
    </div>

  </div>
</footer>

  <form id="load-more-state-form" style="overflow:hidden;width:1px;height:1px;margin:0;padding:0;position:absolute;bottom:0;">
  <input id="load-more-state" type="checkbox" tabindex="-1" aria-hidden="true">
</form>


  <script>
    var Futurice = {
      siteId: 377,
      itemsPerPage: 8
    };
    var APIBASEPATH = "https://flockler.com/api";
  </script>

  <script src="../../static.flockler.com/assets/futurice/javascripts/application-689c6d006591a03af50a5a56fc93ce18.js" type="text/javascript"></script>
  <!--[if IE 8 ]>
<link href="//static.flockler.com/respond-proxy.html" id="respond-proxy" rel="respond-proxy" />
<link href="/respond.proxy.gif" id="respond-redirect" rel="respond-redirect" />
<script src="/respond.proxy.js"></script>
<![endif]-->


  <aside class="cookie-notice js-cookie-notice">
  <p class="cookie-notice__description">
    By continuing to use this site, you agree to the use of cookies.
    You can change this and find out more by following&nbsp;this&nbsp;<a href="../cookies.html">link</a>.
  </p>
  <button type="button" class="cookie-notice__button js-cookie-notice__button">Accept cookies</button>
</aside>


    <!-- Start of Async HubSpot Analytics Code -->
    <script type="text/javascript">
      (function(d,s,i,r) {
        if (d.getElementById(i)){return;}
        var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
        n.id=i;n.src='//js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/553433.js';
        e.parentNode.insertBefore(n, e);
      })(document,"script","hs-analytics",300000);
    </script>
    <!-- End of Async HubSpot Analytics Code -->
</body>

<!-- Mirrored from futurice.com/blog/an-example-of-functional-design by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 14 Apr 2016 08:10:25 GMT -->
</html>
